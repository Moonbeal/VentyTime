@page "/create-event"
@attribute [Authorize(Roles = "Admin, Organizer")]
@using VentyTime.Shared.Models
@using System.ComponentModel.DataAnnotations
@using System.Security.Claims
@using System.Net.Http
@using System.Net.Http.Headers
@using Microsoft.AspNetCore.Components.Forms
@inject IEventService EventService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IHttpClientFactory ClientFactory

<MudContainer MaxWidth="MaxWidth.Medium" Class="mt-4">
    <MudPaper Class="pa-4">
        <MudForm @ref="form" Model="@eventModel" @bind-IsValid="@isValid">
            <MudText Typo="Typo.h4" Class="mb-4">Create New Event</MudText>

            <MudTextField @bind-Value="eventModel.Title"
                         Label="Title"
                         Required="true"
                         RequiredError="Title is required"
                         MaxLength="100"
                         Counter="100"
                         Class="mb-4" />

            <MudTextField @bind-Value="eventModel.Description"
                         Label="Description"
                         Required="true"
                         RequiredError="Description is required"
                         Lines="3"
                         MaxLength="500"
                         Counter="500"
                         Class="mb-4" />

            <MudSelect @bind-Value="eventModel.Category"
                      Label="Category"
                      Required="true"
                      RequiredError="Category is required"
                      Class="mb-4">
                @foreach (var category in EventCategories.All)
                {
                    <MudSelectItem Value="@category">@category</MudSelectItem>
                }
            </MudSelect>

            <MudTextField @bind-Value="eventModel.Location"
                         Label="Location"
                         Required="true"
                         RequiredError="Location is required"
                         Class="mb-4" />

            <MudDatePicker Date="@eventModel.StartDate"
                          DateChanged="@(date => OnDateChanged(date))"
                          Label="Date"
                          Required="true"
                          RequiredError="Date is required"
                          DisablePast="true"
                          DateFormat="dd/MM/yyyy"
                          Class="mb-4"
                          AdornmentColor="Color.Primary" />

            <MudTimePicker Time="@eventModel.StartDate.TimeOfDay"
                          TimeChanged="@(time => OnTimeChanged(time))"
                          Label="Time"
                          Required="true"
                          RequiredError="Time is required"
                          AmPm="false"
                          Class="mb-4"
                          AdornmentColor="Color.Primary" />

            <MudPaper Class="pa-4 mb-4" Outlined="true">
                <InputFile id="fileInput" OnChange="OnInputFileChanged" hidden />
                <div class="d-flex flex-column gap-4 align-center justify-center py-4">
                    @if (!string.IsNullOrEmpty(eventModel.ImageUrl))
                    {
                        <MudImage Src="@eventModel.ImageUrl" Alt="Event image" Width="200" Height="200" ObjectFit="ObjectFit.Cover" Class="rounded-lg" />
                        <MudButton OnClick="@(() => ClearImage())" 
                                 Color="Color.Error" 
                                 Variant="Variant.Text" 
                                 StartIcon="@Icons.Material.Filled.Delete">
                            Remove Image
                        </MudButton>
                    }
                    else
                    {
                        <MudIcon Icon="@Icons.Material.Filled.AddPhotoAlternate" Size="Size.Large" />
                        <MudButton HtmlTag="label"
                                 Variant="Variant.Filled"
                                 Color="Color.Primary"
                                 StartIcon="@Icons.Material.Filled.CloudUpload"
                                 for="fileInput">
                            Upload Event Image
                        </MudButton>
                    }
                </div>
            </MudPaper>

            <div class="d-flex justify-space-between mt-6">
                <MudButton OnClick="@(() => NavigationManager.NavigateTo("/"))"
                          Variant="Variant.Outlined"
                          Color="Color.Secondary">
                    Cancel
                </MudButton>
                <MudButton OnClick="CreateEventAsync"
                          Variant="Variant.Filled"
                          Color="Color.Primary"
                          Disabled="@(!isValid || processing)">
                    @if (processing)
                    {
                        <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true" />
                        <MudText Class="ms-2">Creating...</MudText>
                    }
                    else
                    {
                        <MudText>Create Event</MudText>
                    }
                </MudButton>
            </div>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private Event eventModel = new()
    {
        StartDate = DateTime.Now.Date.AddDays(1).AddHours(12),
        Category = EventCategories.Technology
    };
    private MudForm form;
    private bool isValid;
    private bool processing;
    private IBrowserFile uploadedFile;

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        try
        {
            var file = e.File;
            if (file == null)
                return;

            if (file.Size > 5 * 1024 * 1024) // 5MB limit
            {
                Snackbar.Add("File is too large. Maximum size is 5MB.", Severity.Error);
                return;
            }

            var allowedExtensions = new[] { ".jpg", ".jpeg", ".png", ".gif" };
            var extension = Path.GetExtension(file.Name).ToLowerInvariant();
            if (!allowedExtensions.Contains(extension))
            {
                Snackbar.Add($"Invalid file format. Allowed formats are: {string.Join(", ", allowedExtensions)}", Severity.Error);
                return;
            }

            uploadedFile = file;
            var content = new MultipartFormDataContent();
            var fileContent = new StreamContent(file.OpenReadStream(maxAllowedSize: 5 * 1024 * 1024));
            fileContent.Headers.ContentType = new MediaTypeHeaderValue(file.ContentType);
            content.Add(fileContent, "file", file.Name);

            // Get the HttpClient with the correct base address
            var client = ClientFactory.CreateClient("VentyTime.ServerAPI");
            var response = await client.PostAsync("api/Upload", content);
            
            if (response.IsSuccessStatusCode)
            {
                var uploadedPath = await response.Content.ReadAsStringAsync();
                eventModel.ImageUrl = uploadedPath;
                StateHasChanged();
                Snackbar.Add("Image uploaded successfully!", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to upload image: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error uploading image: {ex.Message}", Severity.Error);
        }
    }

    private void ClearImage()
    {
        eventModel.ImageUrl = null;
        uploadedFile = null;
        StateHasChanged();
    }

    private void OnDateChanged(DateTime? date)
    {
        if (date.HasValue)
        {
            var time = eventModel.StartDate.TimeOfDay;
            eventModel.StartDate = date.Value.Date + time;
            eventModel.EndDate = eventModel.StartDate.AddHours(1);
        }
    }

    private void OnTimeChanged(TimeSpan? time)
    {
        if (time.HasValue)
        {
            eventModel.StartDate = eventModel.StartDate.Date + time.Value;
            eventModel.EndDate = eventModel.StartDate.AddHours(1);
        }
    }

    protected override async Task OnInitializedAsync()
    {
        var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
        var user = authState.User;

        if (!user.Identity?.IsAuthenticated ?? true)
        {
            NavigationManager.NavigateTo("/login");
            return;
        }

        eventModel.OrganizerId = user.FindFirst(ClaimTypes.NameIdentifier)?.Value;
    }

    private async Task CreateEventAsync()
    {
        if (!isValid) return;

        try
        {
            processing = true;
            await form.Validate();

            if (form.IsValid)
            {
                var createdEvent = await EventService.CreateEventAsync(eventModel);
                Snackbar.Add("Event created successfully!", Severity.Success);
                NavigationManager.NavigateTo($"/events/{createdEvent.Id}");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating event: {ex.Message}", Severity.Error);
        }
        finally
        {
            processing = false;
        }
    }
}
