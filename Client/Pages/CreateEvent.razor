@page "/create-event"
@using VentyTime.Shared.Models
@inject IEventService EventService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IUserService UserService
@inject IJSRuntime JSRuntime
@inject Blazored.LocalStorage.ILocalStorageService LocalStorage
@attribute [Authorize]

<MudContainer MaxWidth="MaxWidth.Medium" Class="my-8">
    <MudPaper Elevation="3" Class="pa-6 rounded-lg">
        <MudText Typo="Typo.h4" Color="Color.Primary" Class="mb-6">Create New Event</MudText>

        <MudForm @ref="form" @bind-IsValid="@success">
            <MudGrid Spacing="3">
                <MudItem xs="12">
                    <MudTextField @bind-Value="eventModel.Title"
                                Label="Event Title"
                                For="@(() => eventModel.Title)"
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Title is required!"
                                Immediate="true"
                                Counter="100"
                                MaxLength="100"
                                id="event-title"
                                HelperText="Give your event a catchy title" />
                </MudItem>

                <MudItem xs="12">
                    <MudTextField @bind-Value="eventModel.Description"
                                Label="Description"
                                For="@(() => eventModel.Description)"
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Description is required!"
                                Lines="4"
                                Counter="500"
                                MaxLength="500"
                                id="event-description"
                                HelperText="Describe your event in detail" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudSelect T="string" 
                              Label="Category" 
                              For="@(() => eventModel.Category)"
                              @bind-Value="eventModel.Category"
                              Required="true"
                              RequiredError="Category is required!"
                              AnchorOrigin="Origin.BottomCenter"
                              id="event-category"
                              Variant="Variant.Outlined">
                        <MudSelectItem Value="@("Art & Culture")">Art & Culture</MudSelectItem>
                        <MudSelectItem Value="@("Business")">Business</MudSelectItem>
                        <MudSelectItem Value="@("Food & Drinks")">Food & Drinks</MudSelectItem>
                        <MudSelectItem Value="@("Music")">Music</MudSelectItem>
                        <MudSelectItem Value="@("Sports")">Sports</MudSelectItem>
                        <MudSelectItem Value="@("Technology")">Technology</MudSelectItem>
                        <MudSelectItem Value="@("Other")">Other</MudSelectItem>
                    </MudSelect>
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTextField @bind-Value="eventModel.Location"
                                Label="Location"
                                For="@(() => eventModel.Location)"
                                Variant="Variant.Outlined"
                                Required="true"
                                RequiredError="Location is required!"
                                Adornment="Adornment.Start"
                                AdornmentIcon="@Icons.Material.Filled.LocationOn"
                                id="event-location" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudDatePicker Label="Event Date"
                                 Required="true"
                                 RequiredError="Date is required!"
                                 DisablePastDates="true"
                                 DateFormat="dd/MM/yyyy"
                                 Variant="Variant.Outlined"
                                 Date="eventModel.StartDate"
                                 DateChanged="date => { if (date.HasValue) eventModel.StartDate = date.Value; }"
                                 id="event-date" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudTimePicker Label="Start Time"
                                 Required="true"
                                 RequiredError="Time is required!"
                                 AmPm="true"
                                 TimeFormat="hh:mm tt"
                                 Variant="Variant.Outlined"
                                 @bind-Time="@eventModel.StartTime"
                                 id="event-time" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="eventModel.Price"
                                   Label="Price ($)"
                                   For="@(() => eventModel.Price)"
                                   Required="true"
                                   RequiredError="Price is required!"
                                   Min="0"
                                   Format="N2"
                                   Variant="Variant.Outlined"
                                   Adornment="Adornment.Start"
                                   AdornmentText="$"
                                   id="event-price"
                                   HelperText="Set to 0 for free events" />
                </MudItem>

                <MudItem xs="12" sm="6">
                    <MudNumericField @bind-Value="eventModel.MaxAttendees"
                                   Label="Capacity"
                                   For="@(() => eventModel.MaxAttendees)"
                                   Required="true"
                                   RequiredError="Capacity is required!"
                                   Min="0"
                                   Variant="Variant.Outlined"
                                   id="event-capacity"
                                   HelperText="Set to 0 for unlimited capacity" />
                </MudItem>

                <MudItem xs="12">
                    <MudPaper Class="pa-4" Elevation="0">
                        <InputFile id="fileInput" OnChange="OnInputFileChanged" hidden accept=".jpg,.jpeg,.png" />
                        <MudButton HtmlTag="label"
                                 Variant="Variant.Filled"
                                 Color="Color.Primary"
                                 StartIcon="@Icons.Material.Filled.CloudUpload"
                                 For="fileInput">
                            Upload Image
                        </MudButton>
                        @if (!string.IsNullOrEmpty(eventModel.ImageUrl))
                        {
                            <MudImage Src="@eventModel.ImageUrl" Alt="Event image" Width="200" Height="200" ObjectFit="ObjectFit.Cover" Class="mt-3" />
                        }
                    </MudPaper>
                </MudItem>

                <MudItem xs="12" Class="d-flex justify-space-between align-center mt-4">
                    <MudButton OnClick="@(() => NavigationManager.NavigateTo("/events"))"
                              Variant="Variant.Outlined"
                              Color="Color.Secondary"
                              Size="Size.Large"
                              StartIcon="@Icons.Material.Filled.ArrowBack">
                        Back
                    </MudButton>

                    <MudButton OnClick="CreateEventAsync"
                              Disabled="!success"
                              Variant="Variant.Filled"
                              Color="Color.Primary"
                              Size="Size.Large"
                              EndIcon="@Icons.Material.Filled.Send">
                        Create Event
                    </MudButton>
                </MudItem>
            </MudGrid>
        </MudForm>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? form;
    private bool success;
    private Event eventModel = new Event
    {
        StartDate = DateTime.Now,
        StartTime = TimeSpan.FromHours(12)
    };
    private IBrowserFile? selectedFile;

    private async Task OnInputFileChanged(InputFileChangeEventArgs e)
    {
        selectedFile = e.File;
        if (selectedFile != null)
        {
            try
            {
                // Get the current auth token
                var token = await LocalStorage.GetItemAsync<string>("authToken");
                if (string.IsNullOrEmpty(token))
                {
                    Snackbar.Add("Please log in to upload images", Severity.Warning);
                    return;
                }

                using var content = new MultipartFormDataContent();
                using var fileContent = new StreamContent(selectedFile.OpenReadStream(maxAllowedSize: 4096000));
                fileContent.Headers.ContentType = new System.Net.Http.Headers.MediaTypeHeaderValue(selectedFile.ContentType);
                content.Add(fileContent, "file", selectedFile.Name);

                var response = await EventService.UploadEventImage(content);
                if (response.IsSuccessful)
                {
                    eventModel.ImageUrl = response.Data;
                    Snackbar.Add("Image uploaded successfully!", Severity.Success);
                }
                else
                {
                    Snackbar.Add($"Failed to upload image: {response.Message}", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error uploading image: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task CreateEventAsync()
    {
        try
        {
            await form?.Validate();
            if (form?.IsValid ?? false)
            {
                var userId = await UserService.GetCurrentUserIdAsync();
                if (string.IsNullOrEmpty(userId))
                {
                    Snackbar.Add("Please log in to create events", Severity.Warning);
                    return;
                }

                eventModel.OrganizerId = userId;
                // Keep StartTime as TimeSpan, no need to convert to string
                var createdEvent = await EventService.CreateEventAsync(eventModel);
                Snackbar.Add("Event created successfully!", Severity.Success);
                NavigationManager.NavigateTo($"/event/{createdEvent.Id}");
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating event: {ex.Message}", Severity.Error);
        }
    }
}
