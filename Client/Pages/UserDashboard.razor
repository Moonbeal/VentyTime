@page "/dashboard"
@using VentyTime.Shared.Models
@using VentyTime.Client.Services
@using VentyTime.Client.Shared
@using System.Security.Claims
@inject IUserService UserService
@inject IEventService EventService
@inject IRegistrationService RegistrationService
@inject NavigationManager NavigationManager
@inject ISnackbar Snackbar
@inject IDialogService DialogService
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject INotificationService NotificationService

<MudContainer MaxWidth="MaxWidth.Large" Class="pa-4">
    @if (isLoading)
    {
        <div class="d-flex justify-center">
            <MudProgressCircular Color="Color.Primary" Indeterminate="true" Size="Size.Large" />
        </div>
    }
    else if (errorMessage != null)
    {
        <MudAlert Severity="Severity.Error" Variant="Variant.Filled" Class="my-4">
            @errorMessage
        </MudAlert>
    }
    else
    {
        <MudGrid>
            <MudItem xs="12" sm="12" md="4" lg="3">
                <MudPaper Class="pa-4" Style="@($"background: linear-gradient(to bottom, var(--mud-palette-primary) 30%, var(--mud-palette-background) 30%);")">
                    <div class="d-flex flex-column align-center">
                        <MudAvatar Style="width: 150px; height: 150px; border: 4px solid var(--mud-palette-background);" Class="mud-elevation-5">
                            @if (!string.IsNullOrEmpty(currentUser?.AvatarUrl))
                            {
                                <MudImage Src="@currentUser.AvatarUrl" Alt="User avatar" Style="width: 100%; height: 100%; object-fit: cover;" />
                            }
                            else
                            {
                                <MudIcon Icon="@Icons.Material.Filled.Person" Size="Size.Large" />
                            }
                        </MudAvatar>
                        <MudText Typo="Typo.h5" Class="mt-4">@currentUser?.Username</MudText>
                        @if (!string.IsNullOrEmpty(currentUser?.FirstName) || !string.IsNullOrEmpty(currentUser?.LastName))
                        {
                            <MudText Typo="Typo.body1" Color="Color.Secondary" Class="mt-1">
                                @($"{currentUser?.FirstName} {currentUser?.LastName}")
                            </MudText>
                        }
                        @if (!string.IsNullOrEmpty(currentUser?.PhoneNumber))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                                <MudIcon Icon="@Icons.Material.Filled.Phone" Size="Size.Small" Class="mr-1" />
                                @currentUser.PhoneNumber
                            </MudText>
                        }
                        @if (!string.IsNullOrEmpty(currentUser?.Email))
                        {
                            <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mt-1">
                                <MudIcon Icon="@Icons.Material.Filled.Email" Size="Size.Small" Class="mr-1" />
                                @currentUser.Email
                            </MudText>
                        }
                        <MudText Typo="Typo.body2" Color="Color.Primary" Class="mb-n1">
                            Member since @(GetFormattedMemberSince())
                        </MudText>
                        
                        <MudDivider Class="mb-4 mt-2" />
                        
                        <div class="d-flex flex-wrap justify-center gap-2 mb-4">
                            @foreach (var role in userRoles)
                            {
                                <MudChip Color="Color.Primary" Size="Size.Small" Class="rounded-pill" Variant="Variant.Outlined">
                                    @role
                                </MudChip>
                            }
                            @if (!userRoles.Any())
                            {
                                <MudChip Color="Color.Error" Size="Size.Small">No roles found</MudChip>
                            }
                        </div>
                        
                        <MudButton Variant="Variant.Filled"
                                  Color="Color.Primary"
                                  StartIcon="@Icons.Material.Filled.Settings"
                                  OnClick="@(() => NavigationManager.NavigateTo("/profile-settings"))"
                                  FullWidth="true">
                            Profile Settings
                        </MudButton>
                    </div>
                </MudPaper>
            </MudItem>

            <MudItem xs="12" sm="12" md="8" lg="9">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4" Class="mud-elevation-4" @bind-SelectedIndex="selectedTab">
                    <MudTabPanel Text="Upcoming Events" Icon="@Icons.Material.Filled.Event">
                        @if (!registeredEvents.Where(e => e.StartDate > DateTime.Now).Any())
                        {
                            <div class="d-flex flex-column align-center py-8">
                                <MudIcon Icon="@Icons.Material.Filled.Event" 
                                        Color="Color.Secondary" 
                                        Size="Size.Large" 
                                        Class="mb-4" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">No Upcoming Events</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                    You haven't registered for any upcoming events yet.
                                </MudText>
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          OnClick="@(() => NavigationManager.NavigateTo("/"))">
                                    Browse Events
                                </MudButton>
                            </div>
                        }
                        else
                        {
                            <MudGrid Spacing="4">
                                @foreach (var evt in registeredEvents.Where(e => e.StartDate > DateTime.Now).OrderBy(e => e.StartDate))
                                {
                                    <MudItem xs="12" sm="6" md="6">
                                        <MudCard Elevation="2" Class="rounded">
                                            <MudCardHeader>
                                                <CardHeaderContent>
                                                    <MudText Typo="Typo.h6">@evt.Title</MudText>
                                                </CardHeaderContent>
                                                <CardHeaderActions>
                                                    @if (evt.StartDate > DateTime.Now)
                                                    {
                                                        <MudChip Size="Size.Small"
                                                                Color="Color.Success"
                                                                Class="rounded-pill">
                                                            Upcoming
                                                        </MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudChip Size="Size.Small"
                                                                Color="Color.Default"
                                                                Class="rounded-pill">
                                                            Past
                                                        </MudChip>
                                                    }
                                                </CardHeaderActions>
                                            </MudCardHeader>
                                            <MudCardContent>
                                                <div class="d-flex align-center mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="mr-2" />
                                                    <MudText>@evt.StartDate.ToString("MMM dd, yyyy HH:mm")</MudText>
                                                </div>
                                                <div class="d-flex align-center">
                                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Class="mr-2" />
                                                    <MudText>@evt.Location</MudText>
                                                </div>
                                            </MudCardContent>
                                            <MudCardActions>
                                                <MudButton Variant="Variant.Text"
                                                          Color="Color.Primary"
                                                          OnClick="@(() => NavigationManager.NavigateTo($"/event/{evt.Id}"))"
                                                          StartIcon="@Icons.Material.Filled.Visibility">
                                                    View Details
                                                </MudButton>
                                            </MudCardActions>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>
                        }
                    </MudTabPanel>

                    <MudTabPanel Text="All Registered Events" Icon="@Icons.Material.Filled.EventNote">
                        @if (!registeredEvents.Any())
                        {
                            <div class="d-flex flex-column align-center py-8">
                                <MudIcon Icon="@Icons.Material.Filled.Event" 
                                        Color="Color.Secondary" 
                                        Size="Size.Large" 
                                        Class="mb-4" />
                                <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">No Registered Events</MudText>
                                <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                    You haven't registered for any events yet.
                                </MudText>
                                <MudButton Variant="Variant.Filled"
                                          Color="Color.Primary"
                                          OnClick="@(() => NavigationManager.NavigateTo("/"))">
                                    Browse Events
                                </MudButton>
                            </div>
                        }
                        else
                        {
                            <MudGrid Spacing="4">
                                @foreach (var evt in registeredEvents.OrderByDescending(e => e.StartDate))
                                {
                                    <MudItem xs="12" sm="6" md="6">
                                        <MudCard Elevation="2" Class="rounded">
                                            <MudCardHeader>
                                                <CardHeaderContent>
                                                    <MudText Typo="Typo.h6">@evt.Title</MudText>
                                                </CardHeaderContent>
                                                <CardHeaderActions>
                                                    @if (evt.StartDate > DateTime.Now)
                                                    {
                                                        <MudChip Size="Size.Small"
                                                                Color="Color.Success"
                                                                Class="rounded-pill">
                                                            Upcoming
                                                        </MudChip>
                                                    }
                                                    else
                                                    {
                                                        <MudChip Size="Size.Small"
                                                                Color="Color.Default"
                                                                Class="rounded-pill">
                                                            Past
                                                        </MudChip>
                                                    }
                                                </CardHeaderActions>
                                            </MudCardHeader>
                                            <MudCardContent>
                                                <div class="d-flex align-center mb-2">
                                                    <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="mr-2" />
                                                    <MudText>@evt.StartDate.ToString("MMM dd, yyyy HH:mm")</MudText>
                                                </div>
                                                <div class="d-flex align-center">
                                                    <MudIcon Icon="@Icons.Material.Filled.LocationOn" Class="mr-2" />
                                                    <MudText>@evt.Location</MudText>
                                                </div>
                                            </MudCardContent>
                                            <MudCardActions>
                                                <MudButton Variant="Variant.Text"
                                                          Color="Color.Primary"
                                                          OnClick="@(() => NavigationManager.NavigateTo($"/event/{evt.Id}"))"
                                                          StartIcon="@Icons.Material.Filled.Visibility">
                                                    View Details
                                                </MudButton>
                                            </MudCardActions>
                                        </MudCard>
                                    </MudItem>
                                }
                            </MudGrid>
                        }
                    </MudTabPanel>

                    @if (userRoles.Any(r => r.Equals("Admin", StringComparison.OrdinalIgnoreCase) || 
                                     r.Equals("Organizer", StringComparison.OrdinalIgnoreCase)))
                    {
                        <MudTabPanel Text="My Events" Icon="@Icons.Material.Filled.EventAvailable">
                            @if (!userEvents.Any())
                            {
                                <div class="d-flex flex-column align-center py-8">
                                    <MudIcon Icon="@Icons.Material.Filled.Event" 
                                            Color="Color.Secondary" 
                                            Size="Size.Large" 
                                            Class="mb-4" />
                                    <MudText Typo="Typo.h6" Color="Color.Secondary" Class="mb-2">No Events Created</MudText>
                                    <MudText Typo="Typo.body2" Color="Color.Secondary" Class="mb-4">
                                        You haven't created any events yet.
                                    </MudText>
                                    <MudButton Variant="Variant.Filled"
                                              Color="Color.Primary"
                                              OnClick="@(() => NavigationManager.NavigateTo("/events/create"))">
                                        Create Event
                                    </MudButton>
                                </div>
                            }
                            else
                            {
                                <MudGrid Spacing="4">
                                    @foreach (var evt in userEvents.OrderByDescending(e => e.StartDate))
                                    {
                                        <MudItem xs="12" sm="6" md="6">
                                            <MudCard Elevation="2" Class="rounded">
                                                <MudCardHeader>
                                                    <CardHeaderContent>
                                                        <MudText Typo="Typo.h6">@evt.Title</MudText>
                                                    </CardHeaderContent>
                                                    <CardHeaderActions>
                                                        @if (evt.StartDate > DateTime.Now)
                                                        {
                                                            <MudChip Size="Size.Small"
                                                                    Color="Color.Success"
                                                                    Class="rounded-pill">
                                                                Upcoming
                                                            </MudChip>
                                                        }
                                                        else
                                                        {
                                                            <MudChip Size="Size.Small"
                                                                    Color="Color.Default"
                                                                    Class="rounded-pill">
                                                                Past
                                                            </MudChip>
                                                        }
                                                    </CardHeaderActions>
                                                </MudCardHeader>
                                                <MudCardContent>
                                                    <div class="d-flex align-center mb-2">
                                                        <MudIcon Icon="@Icons.Material.Filled.CalendarToday" Class="mr-2" />
                                                        <MudText>@evt.StartDate.ToString("MMM dd, yyyy HH:mm")</MudText>
                                                    </div>
                                                    <div class="d-flex align-center">
                                                        <MudIcon Icon="@Icons.Material.Filled.LocationOn" Class="mr-2" />
                                                        <MudText>@evt.Location</MudText>
                                                    </div>
                                                </MudCardContent>
                                                <MudCardActions>
                                                    <ButtonCarousel Buttons="@GetEventButtons(evt)" />
                                                </MudCardActions>
                                            </MudCard>
                                        </MudItem>
                                    }
                                </MudGrid>
                            }
                        </MudTabPanel>
                    }
                </MudTabs>
            </MudItem>
        </MudGrid>
    }
</MudContainer>

<style>
    .custom-view-button {
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
</style>

@code {
    private User? currentUser;
    private List<Event> userEvents = new();
    private List<Event> registeredEvents = new();
    private List<string> userRoles = new();
    private bool isLoading = true;
    private string? errorMessage;
    private int selectedTab = 0;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            if (user.Identity?.IsAuthenticated == true)
            {
                currentUser = await UserService.GetCurrentUserAsync();
                userRoles = user.Claims
                    .Where(c => c.Type == System.Security.Claims.ClaimTypes.Role)
                    .Select(c => c.Value)
                    .ToList();

                await LoadEvents();
            }
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task LoadEvents()
    {
        userEvents = await EventService.GetEventsByOrganizerIdAsync(currentUser.Id);
        registeredEvents = await EventService.GetRegisteredEventsAsync();
    }

    private async Task OpenNotificationDialog(Event evt)
    {
        var parameters = new DialogParameters
        {
            ["Title"] = "Send Notification to Event Participants",
            ["ContentText"] = "Enter your message to send to all participants:",
        };

        var dialog = await DialogService.ShowAsync<NotificationDialog>("Send Notification", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            var message = result.Data.ToString();
            if (!string.IsNullOrEmpty(message))
            {
                var notification = new Notification
                {
                    Title = $"Message from {evt.Title} organizer",
                    Message = message,
                    EventId = evt.Id,
                    Link = $"/event/{evt.Id}"
                };

                await NotificationService.SendEventNotificationAsync(notification);
                Snackbar.Add("Notification sent successfully!", Severity.Success);
            }
        }
    }

    private void NavigateToEventDetails(int eventId)
    {
        NavigationManager.NavigateTo($"/event/{eventId}");
    }

    private void NavigateToEventEdit(int eventId)
    {
        NavigationManager.NavigateTo($"/event/{eventId}/edit");
    }

    private async Task DeleteEvent(Event evt)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete event '{evt.Title}'? This action cannot be undone." },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Delete Event", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var (success, error) = await EventService.DeleteEventAsync(evt.Id);
                if (success)
                {
                    Snackbar.Add("Event deleted successfully", Severity.Success);
                    await LoadEvents();
                }
                else
                {
                    Snackbar.Add(error ?? "Failed to delete event", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private async Task ShowDeleteConfirmation(Event evt)
    {
        var parameters = new DialogParameters
        {
            { "ContentText", $"Are you sure you want to delete event '{evt.Title}'? This action cannot be undone." },
            { "ButtonText", "Delete" },
            { "Color", Color.Error }
        };

        var dialog = await DialogService.ShowAsync<DeleteConfirmationDialog>("Delete Event", parameters);
        var result = await dialog.Result;

        if (!result.Canceled)
        {
            try
            {
                var (success, error) = await EventService.DeleteEventAsync(evt.Id);
                if (success)
                {
                    Snackbar.Add("Event deleted successfully", Severity.Success);
                    await LoadEvents();
                }
                else
                {
                    Snackbar.Add(error ?? "Failed to delete event", Severity.Error);
                }
            }
            catch (Exception ex)
            {
                Snackbar.Add($"Error: {ex.Message}", Severity.Error);
            }
        }
    }

    private List<ButtonCarousel.ButtonInfo> GetEventButtons(Event evt)
    {
        return new List<ButtonCarousel.ButtonInfo>
        {
            new ButtonCarousel.ButtonInfo
            {
                Text = "VIEW DETAILS",
                Icon = Icons.Material.Filled.Visibility,
                Color = Color.Primary,
                Variant = Variant.Text,
                OnClick = EventCallback.Factory.Create(this, () => NavigationManager.NavigateTo($"/event/{evt.Id}"))
            },
            new ButtonCarousel.ButtonInfo
            {
                Text = "EDIT",
                Icon = Icons.Material.Filled.Edit,
                Color = Color.Secondary,
                Variant = Variant.Text,
                OnClick = EventCallback.Factory.Create(this, () => NavigationManager.NavigateTo($"/event/{evt.Id}/edit"))
            },
            new ButtonCarousel.ButtonInfo
            {
                Text = "SEND",
                Icon = Icons.Material.Filled.Notifications,
                Color = Color.Info,
                Variant = Variant.Text,
                OnClick = EventCallback.Factory.Create(this, () => OpenNotificationDialog(evt))
            },
            new ButtonCarousel.ButtonInfo
            {
                Text = "PARTICIPANTS",
                Icon = Icons.Material.Filled.Group,
                Color = Color.Info,
                Variant = Variant.Text,
                OnClick = EventCallback.Factory.Create(this, () => NavigationManager.NavigateTo($"/event/{evt.Id}/registrations"))
            },
            new ButtonCarousel.ButtonInfo
            {
                Text = "DELETE",
                Icon = Icons.Material.Filled.Delete,
                Color = Color.Error,
                Variant = Variant.Text,
                OnClick = EventCallback.Factory.Create(this, () => ShowDeleteConfirmation(evt))
            }
        };
    }

    private string GetFormattedMemberSince()
    {
        if (currentUser == null) return string.Empty;
        
        // Якщо дата створення дорівнює мінімальній даті (01.01.0001) або майбутній даті,
        // використовуємо поточну дату
        if (currentUser.CreatedAt <= DateTime.MinValue || currentUser.CreatedAt > DateTime.Now)
        {
            return DateTime.Now.ToString("MMMM yyyy");
        }
        
        return currentUser.CreatedAt.ToLocalTime().ToString("MMMM yyyy");
    }
}
