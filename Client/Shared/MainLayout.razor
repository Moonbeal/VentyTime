@using MudBlazor
@inherits LayoutComponentBase
@inject IDialogService DialogService
@inject NavigationManager NavigationManager
@inject IUserService UserService

<MudThemeProvider @bind-IsDarkMode="@_isDarkMode" Theme="_theme"/>
<MudDialogProvider/>
<MudSnackbarProvider/>

<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudLink Href="" Color="Color.Surface" Underline="Underline.None">
            <MudText Typo="Typo.h5" Color="Color.Surface" Class="ml-4 font-weight-bold">VentyTime</MudText>
        </MudLink>
        <MudSpacer />

        <MudHidden Breakpoint="Breakpoint.SmAndDown">
            <MudButton Href="/" Variant="Variant.Text" Color="Color.Surface" Class="mx-2">Home</MudButton>
            <MudButton Href="/events" Variant="Variant.Text" Color="Color.Surface" Class="mx-2">Events</MudButton>
            <AuthorizeView>
                <Authorized>
                    <MudButton Href="/create-event" Variant="Variant.Text" Color="Color.Surface" Class="mx-2">Create Event</MudButton>
                </Authorized>
            </AuthorizeView>
        </MudHidden>
        
        <AuthorizeView>
            <Authorized>
                <MudMenu ActivationEvent="MouseEvent.LeftClick" AnchorOrigin="Origin.BottomRight" TransformOrigin="Origin.TopRight">
                    <ActivatorContent>
                        <MudAvatar Color="Color.Secondary" Class="ma-2">
                            <MudIcon Icon="@Icons.Material.Filled.Person" />
                        </MudAvatar>
                    </ActivatorContent>
                    <ChildContent>
                        <MudMenuItem Href="/profile">Profile</MudMenuItem>
                        <MudMenuItem Href="/my-events">My Events</MudMenuItem>
                        <MudMenuItem Href="/my-registrations">My Registrations</MudMenuItem>
                        <MudDivider />
                        <MudMenuItem OnClick="Logout">Logout</MudMenuItem>
                    </ChildContent>
                </MudMenu>
            </Authorized>
            <NotAuthorized>
                <MudButton Href="/login" Variant="Variant.Text" Color="Color.Surface" Class="mr-2">Login</MudButton>
                <MudButton Href="/register" Variant="Variant.Filled" Color="Color.Secondary" Class="mr-4">Sign Up</MudButton>
            </NotAuthorized>
        </AuthorizeView>
        
        <MudIconButton Icon="@(_isDarkMode ? Icons.Material.Filled.LightMode : Icons.Material.Filled.DarkMode)" 
                      Color="Color.Surface" 
                      OnClick="@ToggleTheme"
                      Class="mr-4"/>

        <MudHidden Breakpoint="Breakpoint.MdAndUp">
            <MudMenu Icon="@Icons.Material.Filled.Menu" Color="Color.Surface" Edge="Edge.End">
                <MudMenuItem Href="/">Home</MudMenuItem>
                <MudMenuItem Href="/events">Events</MudMenuItem>
                <AuthorizeView>
                    <Authorized>
                        <MudMenuItem Href="/create-event">Create Event</MudMenuItem>
                    </Authorized>
                </AuthorizeView>
            </MudMenu>
        </MudHidden>
    </MudAppBar>

    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.Large" Class="mt-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _isDarkMode;
    private MudTheme _theme = new MudTheme();

    protected override void OnInitialized()
    {
        _theme.Palette = new Palette
        {
            Primary = Colors.Blue.Default,
            Secondary = Colors.Pink.Default,
            AppbarBackground = Colors.Blue.Default,
            Background = Colors.Grey.Lighten5,
            DrawerBackground = Colors.Grey.Lighten5,
            DrawerText = "rgba(0,0,0, 0.7)",
            Success = Colors.Green.Default
        };

        _theme.PaletteDark = new PaletteDark
        {
            Primary = Colors.Blue.Darken1,
            Secondary = Colors.Pink.Lighten1,
            Background = "#1a1a1a",
            Surface = "#252525",
            DrawerBackground = "#1a1a1a",
            DrawerText = "rgba(255,255,255, 0.7)",
            Success = Colors.Green.Darken1
        };
    }

    private void ToggleTheme()
    {
        _isDarkMode = !_isDarkMode;
    }

    private async Task Logout()
    {
        await UserService.LogoutAsync();
        NavigationManager.NavigateTo("/");
    }
}
